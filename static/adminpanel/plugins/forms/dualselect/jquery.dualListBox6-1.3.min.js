/*
 *       Developed by Justin Mead
 *       Â©2011 MeadMiracle
 *		www.meadmiracle.com / meadmiracle@gmail.com
 *       Version 1.5
 *       Testing: IE12/Windows XP
 *                Firefox/Windows XP
 *                Chrome/Windows XP
 *       Licensed under the Creative Commons GPL http://creativecommons.org/licenses/GPL/2.0/
 */
(function ($) {
    var settings11 = new Array();
    var group11 = new Array();
    var group12 = new Array();
    var onSort11 = new Array();
    $.configureBoxes11 = function (options) {
        var index = settings11.push({
            box11View: 'box11View',
            box11Storage: 'box11Storage',
            box11Filter: 'box11Filter',
            box11Clear: 'box11Clear',
            box11Counter: 'box11Counter',
            box12View: 'box12View',
            box12Storage: 'box12Storage',
            box12Filter: 'box12Filter',
            box12Clear: 'box12Clear',
            box12Counter: 'box12Counter',
            to11: 'to11',
            allTo11: 'allTo11',
            to12: 'to12',
            allTo12: 'allTo12',
            transferMode: 'move',
            sortBy: 'text',
            useFilters: true,
            useCounters: true,
            useSorting: false,
            selectOnSubmit: true
        });
        index--;
        $.extend(settings11[index], options);
        group11.push({
            view: settings11[index].box11View,
            storage: settings11[index].box11Storage,
            filter: settings11[index].box11Filter,
            clear: settings11[index].box11Clear,
            counter: settings11[index].box11Counter,
            index: index
        });
        group12.push({
            view: settings11[index].box12View,
            storage: settings11[index].box12Storage,
            filter: settings11[index].box12Filter,
            clear: settings11[index].box12Clear,
            counter: settings11[index].box12Counter,
            index: index
        });
        if (settings11[index].sortBy == 'text') {
            onSort11.push(function (a, b) {
                var aVal = a.text.toLowerCase();
                var bVal = b.text.toLowerCase();
                if (aVal < bVal) {
                    return -1;
                }
                if (aVal > bVal) {
                    return 1;
                }
                return 0;
            });
        } else {
            onSort11.push(function (a, b) {
                var aVal = a.value.toLowerCase();
                var bVal = b.value.toLowerCase();
                if (aVal < bVal) {
                    return -1;
                }
                if (aVal > bVal) {
                    return 1;
                }
                return 0;
            });
        }
        if (settings11[index].useFilters) {
            $('#' + group11[index].filter).keyup(function () {
                Filter(group11[index]);
            });
            $('#' + group12[index].filter).keyup(function () {
                Filter(group12[index]);
            });
            $('#' + group11[index].clear).click(function () {
                ClearFilter(group11[index]);
            });
            $('#' + group12[index].clear).click(function () {
                ClearFilter(group12[index]);
            });
        }
        if (IsMoveMode(settings11[index])) {
            $('#' + group12[index].view).dblclick(function () {
                MoveSelected(group12[index], group11[index]);
            });
            $('#' + settings11[index].to11).click(function () {
                MoveSelected(group12[index], group11[index]);
            });
            $('#' + settings11[index].allTo11).click(function () {
                MoveAll(group12[index], group11[index]);
            });
        } else {
            $('#' + group12[index].view).dblclick(function () {
                RemoveSelected(group12[index], group11[index]);
            });
            $('#' + settings11[index].to11).click(function () {
                RemoveSelected(group12[index], group11[index]);
            });
            $('#' + settings11[index].allTo11).click(function () {
                RemoveAll(group12[index], group11[index]);
            });
        }
        $('#' + group11[index].view).dblclick(function () {
            MoveSelected(group11[index], group12[index]);
        });
        $('#' + settings11[index].to12).click(function () {
            MoveSelected(group11[index], group12[index]);
        });
        $('#' + settings11[index].allTo12).click(function () {
            MoveAll(group11[index], group12[index]);
        });
        if (settings11[index].useCounters) {
            UpdateLabel(group11[index]);
            UpdateLabel(group12[index]);
        }
        if (settings11[index].useSorting) {
            SortOptions(group11[index]);
            SortOptions(group12[index]);
        }
        $('#' + group11[index].storage + ',#' + group12[index].storage).css('display', 'none');
        if (settings11[index].selectOnSubmit) {
            $('#' + settings11[index].box12View).closest('form').submit(function () {
                $('#' + settings11[index].box12View).children('option').attr('selected', 'selected');
            });
        }
    };

    function UpdateLabel(group) {
        var showingCount = $("#" + group.view + " option").size();
        var hiddenCount = $("#" + group.storage + " option").size();
        $("#" + group.counter).text('Showing ' + showingCount + ' of ' + (showingCount + hiddenCount));
    }

    function Filter(group) {
        var index = group.index;
        var filterLower;
        if (settings11[index].useFilters) {
            filterLower = $('#' + group.filter).val().toString().toLowerCase();
        } else {
            filterLower = '';
        }
        $('#' + group.view + ' option').filter(function (i) {
            var toMatch = $(this).text().toString().toLowerCase();
            return toMatch.indexOf(filterLower) == -1;
        }).appendTo('#' + group.storage);
        $('#' + group.storage + ' option').filter(function (i) {
            var toMatch = $(this).text().toString().toLowerCase();
            return toMatch.indexOf(filterLower) != -1;
        }).appendTo('#' + group.view);
        try {
            $('#' + group.view + ' option').removeAttr('selected');
        } catch (ex) {
        }
        if (settings11[index].useSorting) {
            SortOptions(group);
        }
        if (settings11[index].useCounters) {
            UpdateLabel(group);
        }
    }

    function SortOptions(group) {
        var $toSortOptions = $('#' + group.view + ' option');
        $toSortOptions.sort(onSort11[group.index]);
        $('#' + group.view).empty().append($toSortOptions);
    }

    function MoveSelected(fromGroup, toGroup) {
        if (IsMoveMode(settings11[fromGroup.index])) {
            $('#' + fromGroup.view + ' option:selected').appendTo('#' + toGroup.view);
        } else {
            $('#' + fromGroup.view + ' option:selected:not([class*=copiedOption])').clone().appendTo('#' + toGroup.view).end().end().addClass('copiedOption');
        }
        try {
            $('#' + fromGroup.view + ' option,#' + toGroup.view + ' option').removeAttr('selected');
        } catch (ex) {
        }
        Filter(toGroup);
        if (settings11[fromGroup.index].useCounters) {
            UpdateLabel(fromGroup);
        }
    }

    function MoveAll(fromGroup, toGroup) {
        if (IsMoveMode(settings11[fromGroup.index])) {
            $('#' + fromGroup.view + ' option').appendTo('#' + toGroup.view);
        } else {
            $('#' + fromGroup.view + ' option:not([class*=copiedOption])').clone().appendTo('#' + toGroup.view).end().end().addClass('copiedOption');
        }
        try {
            $('#' + fromGroup.view + ' option,#' + toGroup.view + ' option').removeAttr('selected');
        } catch (ex) {
        }
        Filter(toGroup);
        if (settings11[fromGroup.index].useCounters) {
            UpdateLabel(fromGroup);
        }
    }

    function RemoveSelected(removeGroup, otherGroup) {
        $('#' + otherGroup.view + ' option.copiedOption').add('#' + otherGroup.storage + ' option.copiedOption').remove();
        try {
            $('#' + removeGroup.view + ' option:selected').appendTo('#' + otherGroup.view).removeAttr('selected');
        } catch (ex) {
        }
        $('#' + removeGroup.view + ' option').add('#' + removeGroup.storage + ' option').clone().addClass('copiedOption').appendTo('#' + otherGroup.view);
        Filter(otherGroup);
        if (settings11[removeGroup.index].useCounters) {
            UpdateLabel(removeGroup);
        }
    }

    function RemoveAll(removeGroup, otherGroup) {
        $('#' + otherGroup.view + ' option.copiedOption').add('#' + otherGroup.storage + ' option.copiedOption').remove();
        try {
            $('#' + removeGroup.storage + ' option').clone().addClass('copiedOption').add('#' + removeGroup.view + ' option').appendTo('#' + otherGroup.view).removeAttr('selected');
        } catch (ex) {
        }
        Filter(otherGroup);
        if (settings11[removeGroup.index].useCounters) {
            UpdateLabel(removeGroup);
        }
    }

    function ClearFilter(group) {
        $('#' + group.filter).val('');
        $('#' + group.storage + ' option').appendTo('#' + group.view);
        try {
            $('#' + group.view + ' option').removeAttr('selected');
        } catch (ex) {
        }
        if (settings11[group.index].useSorting) {
            SortOptions(group);
        }
        if (settings11[group.index].useCounters) {
            UpdateLabel(group);
        }
    }

    function IsMoveMode(currSettings) {
        return currSettings.transferMode == 'move';
    }
})(jQuery);